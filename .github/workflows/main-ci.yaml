name: CI

on:
    push:
        branches: ['main']
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    lint:
        name: üíÑ Prettier
        runs-on: ubuntu-latest
        steps:
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v4

            - uses: actionsx/prettier@v3
              with:
                  # prettier CLI arguments.
                  args: --check .

    test:
        name: üß™ Tests
        runs-on: ubuntu-latest
        needs: [lint]
        strategy:
            matrix:
                node: [18, 20]
        env:
            TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
            TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.12.1

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v4

            - name: ‚éî Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node }}

            - name: ‚éî Set up pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.4.0

            - name: üì• Download deps
              run: |
                  echo ::group::..:: Mono Repo Tests ::..
                  pnpm install
                  echo ::endgroup::

            - name: üèÑ Run the tests
              run: |
                  echo ::group::..:: Mono Repo Tests ::..
                  pnpm run test
                  echo ::endgroup::

    builds:
        name: üëÄ Test Standalone Builds
        runs-on: ubuntu-latest
        needs: [lint]
        strategy:
            matrix:
                node: [18, 20]
        env:
            TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
            TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.12.1

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v4

            - name: ‚éî Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node }}

            - name: üì• Download deps and builds folder by folder
              run: |
                  rm -f package.json
                  rm -f pnpm-lock.yaml
                  rm -rf node_modules
                  for COMPONENT in `ls components`; do
                      if [ -d "components/${COMPONENT}" ]; then
                        echo ::group::..:: ${COMPONENT} ::..
                        cd components/${COMPONENT} && yarn install && yarn build && cd -;
                        echo ::endgroup::
                      fi  
                  done
    sync:
        name: üçø Sync Doc to Crystallize
        if: github.event_name == 'push' && github.ref_name == 'main'
        runs-on: ubuntu-latest
        needs: [lint, test, builds]
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.12.1

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v4

            - name: ‚éî Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: üì• Download deps
              run: pnpm install && pnpm run build

            - name: üöÄ Sync it!
              env:
                  MARKDOWN_TO_CRYSTALLIZE_SHARED_KEY: ${{ secrets.MARKDOWN_TO_CRYSTALLIZE_SHARED_KEY }}
              run: |
                  for COMPONENT in `ls components`; do
                      if [ -d "components/${COMPONENT}" ]; then
                        echo ::group::..:: ${COMPONENT} ::..
                        node apps/doc2crystallize/build/index.js components/${COMPONENT}/README.md
                        echo ::endgroup::
                      fi  
                  done
