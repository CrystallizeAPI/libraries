name: CI

on:
    push:
        branches: ['main']
    pull_request:
        types: [opened, synchronize, reopened]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: üíÑ Prettier
        runs-on: ubuntu-latest
        steps:
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v5

            - name: ‚éî Setup node
              uses: actions/setup-node@v5
              with:
                  node-version: 22
                  package-manager-cache: false

            - name: ‚éî Set up pnpm
              uses: pnpm/action-setup@v4

            - name: üì• Download deps
              run: pnpm install

            - name: üíÑ Prettier
              run: pnpm run prettier:check
    test:
        name: üß™ Tests
        runs-on: ubuntu-latest
        needs: [lint]
        strategy:
            matrix:
                node: [22, 24]
        steps:
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v5

            - name: ‚éî Setup node
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ matrix.node }}
                  package-manager-cache: false

            - name: ‚éî Set up pnpm
              uses: pnpm/action-setup@v4

            - name: üì• Download deps
              run: |
                  echo ::group::..:: Mono Repo Tests ::..
                  pnpm install && pnpm run build
                  echo ::endgroup::

            - name: üèÑ Run the tests
              env:
                  CRYSTALLIZE_TENANT_ID: 6890ca9cd065ed6bcafdf9e5
                  CRYSTALLIZE_TENANT_IDENTIFIER: js-api-client-integration-tests
                  CRYSTALLIZE_ACCESS_TOKEN_ID: ${{ secrets.CRYSTALLIZE_ACCESS_TOKEN_ID }}
                  CRYSTALLIZE_ACCESS_TOKEN_SECRET: ${{ secrets.CRYSTALLIZE_ACCESS_TOKEN_SECRET }}
              run: |
                  echo ::group::..:: Mono Repo Tests ::..
                  pnpm run test
                  echo ::endgroup::
    sync:
        name: üçø Sync Doc to Crystallize
        if: github.event_name == 'push' && github.ref_name == 'main'
        runs-on: ubuntu-latest
        needs: [lint, test]
        steps:
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v5

            - name: ‚éî Setup node
              uses: actions/setup-node@v5
              with:
                  node-version: 22

            - name: ‚éî Set up pnpm
              uses: pnpm/action-setup@v4

            - name: üì• Download deps
              run: pnpm install && pnpm run build

            - name: üöÄ Sync it!
              env:
                  MARKDOWN_TO_CRYSTALLIZE_SHARED_KEY: ${{ secrets.MARKDOWN_TO_CRYSTALLIZE_SHARED_KEY }}
              run: |
                  for COMPONENT in `ls components`; do
                      if [ -d "components/${COMPONENT}" ]; then
                        echo ::group::..:: ${COMPONENT} ::..
                        node apps/doc2crystallize/build/index.js components/${COMPONENT}/README.md
                        echo ::endgroup::
                      fi  
                  done
